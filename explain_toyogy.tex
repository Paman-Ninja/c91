\newcommand*{\reflisting}[1]{\lstlistingname\ref{#1}}
\renewcommand*\descriptionlabel[1]{\normalfont\headfont #1 :\hfil}

\chapter{詳解:とよぎぃ通信}

とよぎぃ通信はタイプセットに{\pLaTeX}を用いています.
しかしながら,とよぎぃ通信のタイプセットに用いられているパッケージファイルは様々な場所から持ってきた便利っぽい設定の集合体になっているために,このままでは秘伝のタレになってしまいます.
というわけで,本稿ではパッケージファイルを秘伝のタレにしてしまわないために,タイプセットに用いるパッケージファイルを読み解き,可能な限りの解説を試みます.

参考にするとよぎぃ通信のタイプセット設定は第3号で用いたもの\footnote{\url{https://github.com/tut-cc/c90}}です.

\section{クラスそしてプリアンブル}

{\pLaTeX}でのタイプセットに欠かせないものといえば,クラスファイル(\texttt{*.cls})とパッケージファイル(\texttt{*.sty})です.
一般に,クラスファイルで文書とレイアウトとの対応について定義をして,足りない部分をパッケージファイルで補うという形がとられます.
パッケージファイルはスタイルファイルとも呼ばれることがありますが,ここではややこしいのでパッケージファイルで統一します.

{\pLaTeX}で文書をタイプセットするときには,文書の先頭にクラスファイルを指定します.
とよぎぃ通信は同人誌ですから,使うクラスファイルは\texttt{jsclasses}に含まれる書籍用クラスファイル\texttt{jsbook}ということになります.
\reflisting{lis:class}が実際に用いたクラスファイルの指定です.
\begin{lstlisting}[caption=クラスファイルの指定,label=lis:class,language=tex]
\documentclass[papersize, b5paper, tombo, 11pt]{jsbook}
\end{lstlisting}
クラスファイル読み込み時に用いられているオプションの意味はそれぞれ次のような意味を持っています.
%papersize指定してるのにdvipdfmxで-p a4する理由したら意味がない気がするので調査
%description環境のアキがたいへんイケてないので後で直す
\begin{description}
	\item[papersize] DVI(DeVice Independent)ファイルの先頭にpapersizeスペシャル命令を書き込む
	\item[b5paper] 用紙サイズをB5に指定
	\item[tombo] 印刷会社に入稿するときに必要となるトンボの出力
	\item[11pt] 欧文フォントのサイズを11ptに指定
\end{description}

クラスファイルの読み込みから文書の開始までの領域がプリアンブルと呼ばれます.
ここにドキュメントクラスに対する変更等々を書き込むことで,ドキュメントクラスの設定で物足りないちょっとした部分を修正していきます.
\reflisting{lis:preamble}が第3号を刊行した時に用いたプリアンブルの指定です.
\begin{lstlisting}[caption=プリアンブル,label=lis:preamble,language=tex]
\usepackage[dvipdfmx]{graphicx}
\usepackage{comment}
\usepackage{url}
\usepackage{subfigure}
\usepackage{setspace}
\usepackage{amsmath}
\usepackage{multirow}
\usepackage{listings}
\usepackage{toyogy}
\end{lstlisting}
{\LaTeXe}でタイプセットを行ったことがある人ならば説明不要なものでしょう.
% それぞれ次のような意味を持っています.
% \begin{description}
% 	\item[graphicx] :
% 	\item[comment] :
% 	\item[url] :
% 	\item[subfigure] :
% 	\item[setspace] :
% 	\item[amsmath] :
% 	\item[multirow] :
% 	\item[listings] :
% 	\item[toyogy] とよぎぃ通信専用の設定が書き込まれたパッケージファイル
% \end{description}

これらの設定でとよぎぃ通信のタイプセットは行われています.というわけでこれで解説終了と言いたいところですが,ひとつだけ中身が全くわからないパッケージファイルがあります.
\texttt{toyogy.sty}こそがとよぎぃ通信を刊行する上での一番大事なパッケージファイルになのに,このままでは肝心の中身がさっぱりわかりません.
そこで,次節では\texttt{toyogy.sty}の中身について具体的な解説を施します.
\section{toyogy.sty}

とよぎぃ通信におけるタイプセットの主役と言ってもいいのが,この\texttt{toyogy.sty}です.
このパッケージファイルにはとよぎぃ通信を刊行するときに必要となる様々な設定が書き込まれています.これに比べたら今までの説明なんてのはおまけみたいなものです(?).
これまでと同じように,第3号で用いた設定について解説を施しています.
また,パッケージファイルの上から解説を試みると大変なことになるため,作用する領域ごとに分割して解説していきます.

\subsection{ページレイアウトの設定}

本を作成する上で基本となるのが,用紙のどの部分にどの要素を割り当てて使うかということです.
ある本のページを構成する要素は例えば次のように考えられます.
\begin{itemize}
	\item 本文
	\item ページ番号
	\item 脚注
	\item 柱
\end{itemize}
この時,どの要素も過不足なく本のページ内に収まらなければなりません.
もし仮に設定を間違えてページ番号がページ内から抜け落ちてしまった！！なんていうことが起きると目も当てられなくなります.
それを防ぐために,クラスファイルがきちんとページ内に必要な要素が収まるように予めページレイアウトの設定を行っていますが,それが気に食わないということもあります.
とよぎぃ通信の場合もご多分に漏れずクラスファイルの標準の設定が気に入らないということで,ほんの少しだけページレイアウトを修正しています.
\reflisting{list:layout}が実際に用いたページレイアウトの修正です.
\begin{lstlisting}[caption = ページレイアウトの修正,label = list:layout,language = tex]
\setlength{\textwidth}{155truemm}
\setlength{\fullwidth}{\textwidth}
\setlength{\oddsidemargin}{15truemm}
\addtolength{\oddsidemargin}{-1.15truein}
\setlength{\evensidemargin}{15truemm}
\addtolength{\evensidemargin}{-1.15truein}
\setlength{\topmargin}{30truemm}
\addtolength{\topmargin}{-2.4truein}
\setlength{\textheight}{230truemm}
\addtolength{\footskip}{8truemm}
\end{lstlisting}
何が何やらという感じなので,一つずつ見ていきましょう.
まずはじめに\verb|\|から始まる文字列がそこかしこに現れていますが,これらはマクロと呼ばれるものです.
{\pLaTeX}では,このようなマクロを記述することで,様々な設定が行えるようになっています\footnote{正確に言えば{\LaTeX}のユーザー定義命令や{\TeX}のcontrol sequenceなどの混在であるが,簡便のためにマクロとしている}.

マクロを用いたページレイアウトの修正を理解するには,はじめに{\pLaTeX}がどのようにページレイアウトを行っているのかを知らねばなりません.
{\pLaTeX}では,用紙に対して文字を挿入するための領域が四つあり,それぞれ"ヘッダー","フッター","本文","傍注"と言います.\footnote{英語の場合はそれぞれ"header", "footer", "body", "margin note"}.
この中で最も重要なのが"本文"領域で,ここに文章が挿入されていくことになります.
"ヘッダー"は日本語書籍の場合"柱"と呼ばれる領域で,書籍によってはここに章番号や章タイトルを挿入して,現在のページがどの章に属しているかを明示します.
"フッター"にはノンブル,つまりページ番号が主に挿入されます.
"傍注"は普段あまり見ることはないかもしれませんが,文章の特定箇所に追加で説明を加えたい場合に"本文"領域の欄外に文章を挿入するために使われます.
それぞれの領域の配置は"本文"領域を中心として,上に"ヘッダー"領域,下に"フッター"領域,ページの小口側に"傍注"領域が配置されることになります.
%ノド,小口,天,地の説明が必要かどうか
マクロを用いることでこれらの位置関係を守りながら,所望のページレイアウトを作り出していきます.

\reflisting{list:layout}での"本文"領域の大きさの設定は次の2行になります
\begin{verbatim}
\setlength{\textwidth}{155truemm}
\setlength{\textheight}{230truemm}
\end{verbatim}
本文領域の幅を155mmに,高さを230mmに設定していることが分かります.
それぞれの単位に対して\texttt{true}がついていますが,これは\texttt{jsbook}でタイプセットを行うときは,まずはじめに欧文書体が10ptの大きさとなるように出力したあとに最後にそれらをクラスファイルのフォント指定に合わせて拡大・縮小するためです.
もしも\texttt{true}をつけていないと,領域が縦横それぞれ1.1倍されてしまいますが,\texttt{true}をつけることで所望の出力を得ることができます.

本文領域の大きさが決まったところで,次はどこに配置するのかを決めなければなりません.
標準では本文領域は印刷するページの左側から1inch + \verb|\|\texttt{hoffset}にマージンを追加したものになります.
\texttt{jsbook}では奇数ページと偶数ページでレイアウトの設定が異なるため,それぞれのページに対してマージンを設定する必要があります.
ここで少し問題となるのが,ページの左側からのマージンであるということです.
というのも,日本語書籍のレイアウトでは天,地,ノド,小口のそれぞれのアキについて指定します.
ところが{\pLaTeX}を用いる場合は用紙からの左マージンしか指定できないため,偶数ページでは小口のアキが,奇数ページではノドのアキが指定されることになります.
\begin{verbatim}
\setlength{\oddsidemargin}{15truemm}
\addtolength{\oddsidemargin}{-1.15truein}
\setlength{\evensidemargin}{15truemm}
\addtolength{\evensidemargin}{-1.15truein}
\end{verbatim}
この設定では奇数ページと偶数ページの左マージンをそれぞれ同一にしています.
計算してみると奇数ページと偶数ページのノドと小口の幅は次のようになります.
\begin{description}
	\item[奇数ページのノド] 11.19mm
	\item[奇数ページの小口] 15.81mm
	\item[偶数ページのノド] 15.81mm
	\item[偶数ページの小口] 11.19mm
\end{description}
というわけで,とよぎぃ通信では奇数ページと偶数ページでノドと小口が揃っていないということがよく分かります.
今までのとよぎぃ通信は,奇数ページの方が綴じ側のアキが狭くなっているはずですが,気づかれた方はいるのでしょうか.

さらにフッター領域にも少しだけ手が加えられています.
\begin{lstlisting}[caption = "フッター"領域の設定, label = list:footer, language=tex]
\makeatletter
\def\ps@plainfoot{%
\let\@mkboth\@gobbletwo
\let\@oddhead\@empty
\def\@oddfoot{\normalfont\hfil-- \thepage\ --\hfil}%
\let\@evenhead\@empty
\let\@evenfoot\@oddfoot}
\let\ps@plain\ps@plainfoot
\makeatother
\end{lstlisting}
"フッター"領域の設定で意味をなしているのは\texttt{\def\@oddfoot{\normalfont\hfil-- \thepage\ --\hfil}}のみになります.
というのも,それ以外の設定は\texttt{jsbook}によって指定されているものと寸分違わぬものとなっているためです.
抜き出した設定で行っているのはページ番号をフッターの中央揃えにして,ページ番号の両端にエンダッシュを追加する設定となっています.ただそれだけです.

\subsection{図や表の挿入についての設定}

{\pLaTeX}では図や表はフロートと呼ばれる領域を"本文"領域内部に作成した上で,フロート内に配置されます.
\begin{lstlisting}[caption = フロートまわりの設定, label = list:float, language = tex]
\setlength{\intextsep}{10.5pt}
\setlength{\textfloatsep}{10.5pt}

\renewcommand{\figurename}{Fig.}
\renewcommand{\tablename}{Table }

\makeatletter
\setlength{\abovecaptionskip}{0pt}
\long\def\@makecaption#1#2{%
\vskip\abovecaptionskip
\iftdir\sbox\@tempboxa{#1\hskip1zw#2}%
\else\sbox\@tempboxa{#1 #2}%
\fi
\ifdim \wd\@tempboxa >\hsize
\iftdir #1\hskip1zw#2\relax\par
\else #1 #2\relax\par\fi
\else
\global \@minipagefalse
\hbox to\hsize{\hfil\box\@tempboxa\hfil}%
\fi
\vskip\belowcaptionskip}
\makeatother
\end{lstlisting}
はじめに登場する\verb|\setlength|で示された設定について見ていきます.これらは,フロートの前後のアキについて指定を行います.
\verb|\intextsep|は文中にフロートを挿入した時に,本文と図の間に生じるアキを決定している\footnote{\texttt{float.sty}の\texttt{float@endH}が詳しい}.
文中に挿入された際に,フロートの上下に対して指定されたアキを挿入する.

\subsection{数式についての設定}
\begin{lstlisting}[caption = 数式まわりの設定, label = list:eq, language = tex]
\makeatletter
\@addtoreset{equation}{section}
\def\theequation{\thesection.\arabic{equation}}
\makeatother
\end{lstlisting}
